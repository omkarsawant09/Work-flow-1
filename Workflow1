_api/web/lists/getbytitle('Contractor Holiday Requests')/items(@{triggerOutputs()?['body/ID']})/breakroleinheritance(false,true)length(body('Get_items')?['value']) > 0ğŸ”„ FLOW 1 â€” Excel â†’ SharePoint Sync (DETAILED)
ğŸ¯ Purpose of Flow 1
Read Excel as source of truth
Match rows using Business_Key
Create new SharePoint items
Update changed items only
Deactivate / delete removed items
Never recreate the list
ğŸ”¹ TRIGGER
Action: Recurrence
Frequency: Daily / Hourly (your choice)
Time zone: IST
Why: Controlled, predictable sync (better than â€œwhen file modifiedâ€)
ğŸ”¹ STEP 1 â€” Read Excel Data
Action: List rows present in a table
Setting
Value
Location
SharePoint Site
Document Library
Where Excel lives
File
Your Excel
Table
Table1
Pagination
ON (threshold 5000)
ğŸ“Œ Excel MUST be formatted as a Table or this fails.
ğŸ”¹ STEP 2 â€” Initialize Variables
Variable 1: ExcelKeys
Type: Array
Value: []
Why?
Used later to detect deleted rows
ğŸ”¹ STEP 3 â€” Apply to Each (Excel Row)
Action: Apply to each
Input: value (from Excel rows)
Everything below runs once per Excel row.
ğŸ”¹ STEP 4 â€” Capture Business_Key
Action: Append to array variable
Name: ExcelKeys
Value:
Copy code

items('Apply_to_each')?['Business_Key']
ğŸ“Œ This builds a full list of Excel keys.
ğŸ”¹ STEP 5 â€” Generate Row Hash (Change Detection)
Action: Compose
Expression:
Copy code

concat(
items('Apply_to_each')?['Field_1'],
items('Apply_to_each')?['Field_2'],
items('Apply_to_each')?['Allowed_Users']
)
Why?
If data hasnâ€™t changed â†’ skip update
Saves API calls & improves performance
ğŸ”¹ STEP 6 â€” Find Matching SharePoint Item
Action: Get items
Setting
Value
Site
SharePoint Site
List
Your List
Filter Query

Copy code

Business_Key eq '@{items('Apply_to_each')?['Business_Key']}'
| Top Count | 1 |
ğŸ“Œ Indexed Business_Key = fast lookup
ğŸ”¹ STEP 7 â€” CONDITION: Item Exists?
Condition Expression:
Copy code

length(body('Get_items')?['value']) > 0
ğŸŸ¢ IF YES â†’ UPDATE LOGIC
ğŸ”¹ STEP 8A â€” Compare Hash
Condition:
Copy code

equals(
outputs('Compose'),
first(body('Get_items')?['value'])?['Excel_Row_Hash']
)
If TRUE â†’ Do Nothing
If FALSE â†’ Update
ğŸ”¹ STEP 9A â€” Update Item
Action: Update item
Map:
Field_1 â†’ Excel Field_1
Field_2 â†’ Excel Field_2
Allowed_Users â†’ Excel Allowed_Users
Excel_Row_Hash â†’ New Hash
Record_Status â†’ Excel value
ğŸ“Œ This triggers Flow 2 (Permissions) automatically.
ğŸŸ¢ IF NO â†’ CREATE LOGIC
ğŸ”¹ STEP 8B â€” Create Item
Action: Create item
Map:
Title = Business_Key
Business_Key = Excel Business_Key
All other fields
Excel_Row_Hash
ğŸ“Œ Permissions handled by Flow 2.
ğŸ”´ STEP 10 â€” DELETE / DEACTIVATE LOGIC
After Apply to each completes.
ğŸ”¹ STEP 10A â€” Get All SharePoint Items
Action: Get items
(no filter)
ğŸ”¹ STEP 10B â€” Apply to Each (SharePoint Item)
Condition:
Copy code

not(contains(variables('ExcelKeys'), item()?['Business_Key']))
ğŸ”¹ STEP 10C â€” If TRUE â†’ Item Missing in Excel
Choose ONE:
ğŸŸ¡ Soft Delete (Recommended)
Update item
Copy code

Record_Status = Inactive
ğŸ”´ Hard Delete (Optional)
Delete item
ğŸ“Œ Soft delete keeps audit history.
ğŸ›¡ï¸ ERROR HANDLING (VERY IMPORTANT)
Add Scope: Try
All main logic inside
Add Scope: Catch
Configure run-after â†’ Failed
Log:
Business_Key
Error message
Timestamp
Send admin email (optional)
âš™ï¸ PERFORMANCE SETTINGS
Apply to Each
Turn Concurrency Control OFF
Get Items
Top Count = 1
Indexed column used
concat(
  'Business_x0020_Key eq ''',
  items('Apply_to_each')?['Business_Key'],
  ''''
)
